(self.webpackChunkchatsubo=self.webpackChunkchatsubo||[]).push([[927],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return c},kt:function(){return m}});var a=t(7294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,s=function(e,n){if(null==e)return{};var t,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var o=a.createContext({}),u=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=u(e.components);return a.createElement(o.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,s=e.mdxType,r=e.originalType,o=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=u(t),m=s,h=d["".concat(o,".").concat(m)]||d[m]||p[m]||r;return t?a.createElement(h,l(l({ref:n},c),{},{components:t})):a.createElement(h,l({ref:n},c))}));function m(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var r=t.length,l=new Array(r);l[0]=d;var i={};for(var o in n)hasOwnProperty.call(n,o)&&(i[o]=n[o]);i.originalType=e,i.mdxType="string"==typeof e?e:s,l[1]=i;for(var u=2;u<r;u++)l[u]=t[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},5589:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return i},contentTitle:function(){return o},metadata:function(){return u},toc:function(){return c},default:function(){return d}});var a=t(2122),s=t(9756),r=(t(7294),t(3905)),l=["components"],i={},o="Labels",u={unversionedId:"Providers/labels",id:"Providers/labels",isDocsHomePage:!1,title:"Labels",description:"Les labels sont les m\xe9tadonn\xe9es inscrites par les auteurs des challenges sur les instances et les templates.",source:"@site/docs/20-Providers/20-labels.md",sourceDirName:"20-Providers",slug:"/Providers/labels",permalink:"/docs/Providers/labels",editUrl:"https://github.com/chatsuboctf/chatsubo/docs/20-Providers/20-labels.md",version:"current",sidebarPosition:20,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Plugins",permalink:"/docs/Providers/custom"},next:{title:"Provider",permalink:"/docs/Providers/Docker/provider"}},c=[{value:"Pr\xe9-remplissage",id:"pr\xe9-remplissage",children:[]},{value:"Acc\xe8s initiaux",id:"acc\xe8s-initiaux",children:[]},{value:"G\xe9n\xe9ration dynamique",id:"g\xe9n\xe9ration-dynamique",children:[{value:"Cas concret - CTF ACK&amp;/",id:"cas-concret---ctf-ack",children:[]}]}],p={toc:c};function d(e){var n=e.components,t=(0,s.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"labels"},"Labels"),(0,r.kt)("p",null,"Les labels sont les m\xe9tadonn\xe9es inscrites par les auteurs des challenges sur les instances et les templates."),(0,r.kt)("p",null,"Ces donn\xe9es servent \xe0 pr\xe9-configurer le challenge pour son enregistrement sur la plateforme et \xe0 transmettre des informations cruciales comme le ",(0,r.kt)("inlineCode",{parentName:"p"},"realm")," auquel l'instance appartient, son nom, voire son adresse lorsque la plateforme n'a pas d'autres moyen de la r\xe9cup\xe9rer de mani\xe8re dynamique."),(0,r.kt)("h2",{id:"pr\xe9-remplissage"},"Pr\xe9-remplissage"),(0,r.kt)("p",null,"Par exemple, le texte suivant inscrit dans la ",(0,r.kt)("inlineCode",{parentName:"p"},"Note")," d'une machine h\xe9berg\xe9e sur Proxmox :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"chatsubo.template=magellan\nchatsubo.realm=wz\nchatsubo.address=192.168.1.21\n---\nchatsubo.flags.flag1.value=ESGI{D1sC0v3r_7H3_W0rlD}\nchatsubo.flags.flag1.points=250\nchatsubo.name=Magellan\nchatsubo.description=Challenge cr\xe9\xe9 pour l'ESGI dans le cadre du cours 'Challenges et CTF'.\nchatsubo.os=Linux\nchatsubo.category=Test technique\nchatsubo.difficulty=4\nchatsubo.duration=60\n")),(0,r.kt)("p",null,"Pr\xe9-remplira le formulaire d'enregistrement de la mani\xe8re suivante :"),(0,r.kt)("center",null,(0,r.kt)("figure",null,(0,r.kt)("a",{href:"/img/prefill_magellan_1.png",target:"_blank"},(0,r.kt)("img",{src:"/img/prefill_magellan_1.png"})),(0,r.kt)("center",null,(0,r.kt)("figcaption",null,(0,r.kt)("i",null,'Pr\xe9-remplissage de l\'\xe9tape "Informations"'))))),(0,r.kt)("center",null,(0,r.kt)("figure",null,(0,r.kt)("a",{href:"/img/prefill_magellan_2.png",target:"_blank"},(0,r.kt)("img",{src:"/img/prefill_magellan_2.png"})),(0,r.kt)("center",null,(0,r.kt)("figcaption",null,(0,r.kt)("i",null,'Pr\xe9-remplissage de l\'\xe9tape "Configuration"'))))),(0,r.kt)("center",null,(0,r.kt)("figure",null,(0,r.kt)("a",{href:"/img/prefill_magellan_3.png",target:"_blank"},(0,r.kt)("img",{src:"/img/prefill_magellan_3.png"})),(0,r.kt)("center",null,(0,r.kt)("figcaption",null,(0,r.kt)("i",null,'Pr\xe9-remplissage de l\'\xe9tape "Flags"'))))),(0,r.kt)("h2",{id:"acc\xe8s-initiaux"},"Acc\xe8s initiaux"),(0,r.kt)("p",null,"Les labels permettent \xe9galement de configurer une ou plusieurs paires d'identifiants qui seront mis \xe0 disposition du joueur au sein de l'interface."),(0,r.kt)("p",null,"Ainsi, ces labels : "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ini"},"chatsubo.creds.ssh.username=esgi\nchatsubo.creds.ssh.password=3s51E5gi\nchatsubo.creds.smtp.username=magellan\nchatsubo.creds.smtp.password=m4g31lAn\n")),(0,r.kt)("p",null,"Afficheront sur l'interface :"),(0,r.kt)("center",null,(0,r.kt)("figure",null,(0,r.kt)("a",{href:"/img/preconf_access.png",target:"_blank"},(0,r.kt)("img",{src:"/img/preconf_access.png"})),(0,r.kt)("center",null,(0,r.kt)("figcaption",null,(0,r.kt)("i",null,"Pr\xe9-configuration d'acc\xe8s initiaux"))))),(0,r.kt)("h2",{id:"g\xe9n\xe9ration-dynamique"},"G\xe9n\xe9ration dynamique"),(0,r.kt)("p",null,"Docker permet, lors du build d'une image, de passer des variables au Dockerfile."),(0,r.kt)("p",null,"Nous pouvons utiliser ce m\xe9canisme pour fournir \xe0 l'auteur plusieurs variables al\xe9atoires qu'il pourra int\xe9grer \xe0 son challenge."),(0,r.kt)("p",null,"Ainsi, lors de l'instanciation d'un template dynamique, Chatsubo g\xe9n\xe8re et transmet automatiquement les variables suivantes :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"$FLAG0 .. $FLAG50 ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"La valeur correspond aux 35 premiers caract\xe8res du SHA1 d'une cha\xeene de caract\xe8res al\xe9atoires sur l'espace ","[A-Za-z0-9]"),(0,r.kt)("li",{parentName:"ul"},"Exemple (avec ",(0,r.kt)("inlineCode",{parentName:"li"},"flag_prefix: FLAG"),") : FLAG{5dff85a4334b99e1ccd8b3766b212d6a09b}"),(0,r.kt)("li",{parentName:"ul"},"Pseudocode : ",(0,r.kt)("inlineCode",{parentName:"li"},"sha1(randstr(32)).hex()[:35]")))),(0,r.kt)("li",{parentName:"ul"},"$RNG0 .. $RNG50 ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Ces variables contiennent une cha\xeene de 8 caract\xe8res al\xe9atoires sur l'espace ","[A-Za-z0-9]"),(0,r.kt)("li",{parentName:"ul"},"Exemple : 2Cxr9y5F"),(0,r.kt)("li",{parentName:"ul"},"Une telle valeur peut \xeatre g\xe9n\xe9r\xe9e gr\xe2ce \xe0 la commande bash suivante : ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1"))))))),(0,r.kt)("p",null,"C'est \xe9galement gr\xe2ce \xe0 cette m\xe9canique qu'est \xe9tablit le lien entre une instance et un joueur : un uuid4 est transmis \xe0 la variable SESSION, dont le lien avec l'identifiant de l'utilisateur est cr\xe9\xe9 en base."),(0,r.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Il est imp\xe9ratif pour un Dockerfile dynamique d'exposer un label chatsubo.session."),(0,r.kt)("p",{parentName:"div"},"Pour qu'il soit valide, il doit donc contenir \xe0 minima : "),(0,r.kt)("pre",{parentName:"div"},(0,r.kt)("code",{parentName:"pre"},'ARG SESSION\nLABEL chatsubo.session="$SESSION"\n')))),(0,r.kt)("p",null,"Pour pouvoir acc\xe9der \xe0 ces variables, il est n\xe9cessaire de les d\xe9clarer au sein du Dockerfile gr\xe2ce \xe0 la commande ",(0,r.kt)("inlineCode",{parentName:"p"},"ARG"),"."),(0,r.kt)("p",null,"Exemple : "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-Dockerfile"},"ARG FLAG0\nARG FLAG1\nARG FLAG2\nARG FLAG3\n\nARG RNG0=toor\n")),(0,r.kt)("p",null,"Une fois d\xe9clar\xe9es, ces variables sont utilisables plus bas sous la forme ",(0,r.kt)("inlineCode",{parentName:"p"},"$RNG0"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"$FLAG0"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"$FLAG1"),", etc."),(0,r.kt)("h3",{id:"cas-concret---ctf-ack"},"Cas concret - CTF ACK&/"),(0,r.kt)("p",null,"En combinant les valeurs al\xe9atoires g\xe9n\xe9r\xe9es par Chatsubo et les labels param\xe9tr\xe9s lors de l'instanciation, il est possible d'int\xe9grer des flags et des acc\xe8s dynamiques dans les challenges."),(0,r.kt)("p",null,"C'est ce qui a \xe9t\xe9 utilis\xe9 pour le CTF ACK&/, organis\xe9 par le Hacklab ESGI en f\xe9vrier dernier."),(0,r.kt)("p",null,'Le concept de cet \xe9v\xe8nement \xe9tait de proposer \xe0 chaque joueur 5 "silos"',(0,r.kt)("sup",{parentName:"p",id:"fnref-1"},(0,r.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1"))," de 4 challenges chacun. Chacun de ces \"silos\" correspondaient \xe0 un template dynamique, instanci\xe9 sur demande par les joueurs, et dont les flags et l'identifiant de connexion SSH permettant d'y acc\xe9der \xe9taient g\xe9n\xe9r\xe9s \xe0 la vol\xe9e."),(0,r.kt)("p",null,"Cette g\xe9n\xe9ration dynamique se fait gr\xe2ce aux lignes suivantes : "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'ARG FLAG0\nARG FLAG1\nARG FLAG2\nARG FLAG3\n\nARG RNG0=toor\n\n...\n\nLABEL ... \\\n    chatsubo.creds.ssh.username="level0" \\\n    chatsubo.creds.ssh.password="$RNG0" \\\n    chatsubo.flags.step0.value="$FLAG0" \\\n    chatsubo.flags.step0.points="250" \\\n    chatsubo.flags.step1.value="$FLAG1" \\\n    chatsubo.flags.step1.points="250" \\\n    chatsubo.flags.step2.value="$FLAG2" \\\n    chatsubo.flags.step2.points="250" \\\n    chatsubo.flags.step3.value="$FLAG3" \\\n    chatsubo.flags.step3.points="250" \\\n    ...\n')),(0,r.kt)("p",null,'Exemple d\'un Dockerfile utilis\xe9 pour instancier un "silo" :'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-Dockerfile"},'FROM ubuntu:20.04\n\n# Setup\nRUN apt update\nRUN apt install -y openssh-server vim man less netcat cron python3 qpdf sl\nRUN apt update\nRUN apt install -y build-essential libssl-dev\n\n# Copy challenges resources\nCOPY src/root/etc /etc\n\n# Allow caching of apt by putting it below\n# level0 password\nARG RNG0=toor\n\n# Challenger-bound session, handled by Chatsubo\nARG SESSION\n\n# Register all the generated flag passed by Chatsubo via --build-args\n# ENV is needed to allow entrypoint to access them\nARG FLAG0\nARG FLAG1\nARG FLAG2\nARG FLAG3\n\nENV FLAGS="$FLAG0;$FLAG1;$FLAG2;$FLAG3"\nRUN echo $FLAGS\n\nRUN useradd -ms /bin/bash -p $(openssl passwd -6 "$RNG0") level0\nRUN useradd -ms /bin/bash -p $(openssl passwd -6 "$FLAG0") level1\nRUN useradd -ms /bin/bash -p $(openssl passwd -6 "$FLAG1") level2\nRUN useradd -ms /bin/bash -p $(openssl passwd -6 "$FLAG2") level3\nRUN useradd -ms /bin/bash -p $(openssl passwd -6 "$FLAG3") level4\n\n# Exposed metadata, needed by Chatsubo for dynamic flags, session handling and ssh initial access\nLABEL chatsubo.template="adv_ans02" \\\n        chatsubo.name="ACK&/ Confirm\xe9 - 02" \\\n        chatsubo.description="Deuxi\xe8me instance du parcours confirm\xe9" \\\n        chatsubo.category="Confirm\xe9" \\\n        chatsubo.os="Linux" \\\n        chatsubo.difficulty="7" \\\n        chatsubo.creds.ssh.username="level0" \\\n        chatsubo.creds.ssh.password="$RNG0" \\\n        chatsubo.flags.step0.value="$FLAG0" \\\n        chatsubo.flags.step0.points="250" \\\n        chatsubo.flags.step1.value="$FLAG1" \\\n        chatsubo.flags.step1.points="250" \\\n        chatsubo.flags.step2.value="$FLAG2" \\\n        chatsubo.flags.step2.points="250" \\\n        chatsubo.flags.step3.value="$FLAG3" \\\n        chatsubo.flags.step3.points="250" \\\n        chatsubo.session="$SESSION"\n\n# Add challenges setup scripts\nCOPY src/root /\nRUN chmod u+x /home/level**/ans_init.sh\n\n# Needed for sshd\nRUN mkdir /run/sshd\n\nRUN echo "$FLAGS" > /root/flags\n\nCOPY src/entrypoint.sh /entrypoint.sh\nRUN chmod u+x /entrypoint.sh\n\nENTRYPOINT /bin/bash -c \'/etc/init.d/cron start && cat /root/flags | /entrypoint.sh\'\n\n')),(0,r.kt)("p",null,"Script d'entrypoint correspondant :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nrm -f $0\n\nSCRIPT_NAME="ans_init.sh"\nRAW_FLAGS="$(cat /root/flags)"\nFLAGS=(${RAW_FLAGS//;/ })\n\n# Start challenge setup script for each levels and remove it\nfor i in {0..4}; do\n  current_user="level$i"\n  next_user="level$(($i + 1))"\n  init_script="/home/level$i/$SCRIPT_NAME"\n  current_flag=${FLAGS[i]:-"_"}\n  [ -f "$init_script" ] && bash -c "$init_script $current_flag $current_user $next_user"\n  rm -f $init_script\ndone\n\nrm -f /root/flags\n\n/etc/init.d/cron start\n\n# Allow remote access\nwhile true; do\n  /usr/sbin/sshd -e -D\ndone\n\n')),(0,r.kt)("p",null,"Le script ",(0,r.kt)("inlineCode",{parentName:"p"},"ans_init.sh"),", quant \xe0 lui, se charge de mettre en place les challenges, appliquer les bonnes permissions et placer les flags."),(0,r.kt)("p",null,"Exemple du script du niveau 0 qui s'occupe de :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Placer le flag hors de port\xe9e de l'utilisateur ",(0,r.kt)("inlineCode",{parentName:"li"},"level0")),(0,r.kt)("li",{parentName:"ul"},"Patcher le chemin du flag pr\xe9sent dans le binaire"),(0,r.kt)("li",{parentName:"ul"},"Appliquer les permissions correctes pour que seul le binaire \xe0 exploiter puisse lire le fichier contenant le flag du niveau suivant, ",(0,r.kt)("inlineCode",{parentName:"li"},"level1")," "),(0,r.kt)("li",{parentName:"ul"},"Configurer le setuid du binaire")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Le binaire du challenge, ",(0,r.kt)("inlineCode",{parentName:"p"},"dimensional"),", est compil\xe9 statiquement et a \xe9t\xe9 copi\xe9 au pr\xe9alable dans le r\xe9pertoire de l'utilisateur ",(0,r.kt)("inlineCode",{parentName:"p"},"level0")," au cours du build de l'image ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nFLAG=$1\nCURRENT_USER=$2\nNEXT_USER=$3\nbin_name=dimensional\n\n# Create the flag\'s dir, the flag itself and set the correct permissions\nmkdir "/opt/$NEXT_USER/"\necho $FLAG > "/opt/$NEXT_USER/flag"\nchmod 400 "/opt/$NEXT_USER/flag"\nchown -R "$NEXT_USER:" "/opt/$NEXT_USER/"\n\n# Patch binary with next level user\'s name\nsed -i "s/LEVEL_/$NEXT_USER/g" "/home/$CURRENT_USER/$bin_name"\n\n# Fix permissiosn for the current level\'s user\nchown -R "$CURRENT_USER:" "/home/$CURRENT_USER"/\n\n# Change the owner of the binary and put a setuid on it to allow the binary to read next level\'s flag\nchown "$NEXT_USER:" "/home/$CURRENT_USER/$bin_name"\nchmod +xs "/home/$CURRENT_USER/$bin_name"\n')),(0,r.kt)("div",{className:"footnotes"},(0,r.kt)("hr",{parentName:"div"}),(0,r.kt)("ol",{parentName:"div"},(0,r.kt)("li",{parentName:"ol",id:"fn-1"},"Conteneur compos\xe9 d'une suite de d\xe9fis n\xe9cessitant de les r\xe9ussir pour acc\xe9der au suivant.",(0,r.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")))))}d.isMDXComponent=!0}}]);